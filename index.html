<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Server Status | SBO App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js Library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        body { background-color: #0b0f19; font-family: 'Inter', sans-serif; color: #e2e8f0; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        /* New Card Style based on image_0671da.png */
        .metric-card { 
            background-color: #111827; /* Dark slate/gray */
            border: 1px solid #374151; 
            border-radius: 0.75rem; /* rounded-xl */
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Hover effect to highlight border like the image implies active state */
        .metric-card:hover { 
            border-color: #6366f1; /* Indigo-500 */
            transform: translateY(-2px); 
        }

        /* Chart container style */
        .chart-panel {
            background-color: #111827;
            border: 1px solid #374151;
            border-radius: 0.75rem;
        }

        /* Loading Animation */
        @keyframes scan { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        .loading-bar { background: linear-gradient(270deg, #6366f1, #0b0f19, #6366f1); background-size: 200% 200%; animation: scan 2s ease infinite; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-12 px-4">

    <!-- Header -->
    <header class="w-full max-w-6xl mb-8 flex justify-between items-end border-b border-slate-800 pb-6">
        <div>
            <div class="flex items-center gap-3 mb-2">
                <div class="bg-indigo-600 w-10 h-10 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
                    <i class="fa-solid fa-server text-white text-lg"></i>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tight text-white">System Monitor</h1>
            </div>
        </div>
        <div class="text-right hidden sm:block">
            <div class="text-xs text-slate-500 uppercase tracking-wider font-bold mb-1">Status</div>
            <div id="main-status" class="px-3 py-1 rounded-full bg-slate-800 text-slate-400 text-sm font-bold border border-slate-700 inline-flex items-center gap-2">
                <i class="fa-solid fa-circle-notch fa-spin"></i> CONNECTING
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="w-full max-w-6xl space-y-6">
        
        <!-- Top Row: Key Metrics Cards -->
        <!-- Adjusted grid to match the wide/boxy look of the reference image -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4" id="metrics-container">
            <!-- Loading Skeleton -->
            <div class="metric-card p-6 rounded-xl col-span-full text-center space-y-4 border-dashed border-slate-700">
                <div class="h-2 loading-bar rounded-full w-full max-w-md mx-auto mt-2"></div>
                <p class="text-xs text-slate-500">Establishing secure connection...</p>
            </div>
        </div>

        <!-- Middle Row: Charts (CPU & RAM Only) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- CPU Chart -->
            <div class="chart-panel p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">CPU History</h3>
                    <i class="fa-solid fa-microchip text-slate-600"></i>
                </div>
                <div class="h-64 w-full">
                    <canvas id="cpuChart"></canvas>
                </div>
            </div>

            <!-- Memory Chart -->
            <div class="chart-panel p-5">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-slate-400 text-xs font-bold uppercase tracking-wider">Memory History</h3>
                    <i class="fa-solid fa-memory text-slate-600"></i>
                </div>
                <div class="h-64 w-full">
                    <canvas id="ramChart"></canvas>
                </div>
            </div>
        </div>

    </main>

    <!-- Footer -->
    <footer class="mt-12 text-center text-slate-600 text-xs">
        <p>Live Monitoring Dashboard â€¢ Auto-refreshes every 5s</p>
    </footer>

    <script>
        const API_URL = "https://monitoring.sboapp.so/getinfo";
        const REFRESH_RATE = 5000; // 5 seconds

        // Icons mapping for common JSON keys
        const ICONS = {
            cpu: 'fa-microchip',
            ram: 'fa-memory',
            memory: 'fa-memory',
            disk: 'fa-hard-drive',
            storage: 'fa-hard-drive',
            network: 'fa-network-wired',
            uptime: 'fa-clock',
            standing: 'fa-stopwatch',
            time: 'fa-clock',
            load: 'fa-tachometer-alt',
            os: 'fa-linux',
            ip: 'fa-globe',
            version: 'fa-code-branch',
            hostname: 'fa-server'
        };

        // --- Chart Initialization ---
        let cpuChartInstance = null;
        let ramChartInstance = null;
        const MAX_DATA_POINTS = 20;

        function initCharts() {
            const commonOptions = getChartOptions();

            // CPU Chart
            const ctxCpu = document.getElementById('cpuChart').getContext('2d');
            cpuChartInstance = new Chart(ctxCpu, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'CPU Usage (%)',
                        data: [],
                        borderColor: '#6366f1', // Indigo
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: commonOptions
            });

            // RAM Chart
            const ctxRam = document.getElementById('ramChart').getContext('2d');
            ramChartInstance = new Chart(ctxRam, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Memory Usage',
                        data: [],
                        borderColor: '#10b981', // Emerald
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0
                    }]
                },
                options: commonOptions
            });
        }

        function getChartOptions() {
            return {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(17, 24, 39, 0.95)',
                        titleColor: '#e2e8f0',
                        bodyColor: '#e2e8f0',
                        borderColor: 'rgba(55, 65, 81, 1)',
                        borderWidth: 1
                    }
                },
                scales: {
                    x: {
                        display: false 
                    },
                    y: {
                        beginAtZero: true,
                        grid: {
                            color: 'rgba(55, 65, 81, 0.3)' // Darker grid lines
                        },
                        ticks: {
                            color: '#64748b'
                        }
                    }
                },
                animation: {
                    duration: 0 
                }
            };
        }

        // Helper to format seconds into Day:Hour:Min
        function formatUptime(seconds) {
            if (isNaN(seconds)) return seconds; 
            const d = Math.floor(seconds / (3600*24));
            const h = Math.floor((seconds % (3600*24)) / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            
            // Format: 1:01:30 (Day:Hour:Min)
            return `${d}:${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}`;
        }

        function updateCharts(data) {
            const now = new Date().toLocaleTimeString();

            let cpuVal = null;
            let ramVal = null;

            // SMART SCAN: Loop through ALL data keys
            Object.keys(data).forEach(key => {
                const val = data[key];
                const keyLower = key.toLowerCase();
                
                if (typeof val === 'object' && val !== null) return;

                let numVal = parseFloat(val);
                if (isNaN(numVal)) return;

                // CPU
                if (cpuVal === null && (keyLower.includes('cpu') || keyLower.includes('load'))) {
                    cpuVal = numVal;
                }

                // RAM
                if (ramVal === null && (keyLower.includes('ram') || keyLower.includes('memory') || keyLower.includes('mem'))) {
                    ramVal = numVal;
                }
            });
            
            if (cpuVal !== null) addData(cpuChartInstance, now, cpuVal);
            if (ramVal !== null) addData(ramChartInstance, now, ramVal);
        }

        function addData(chart, label, data) {
            chart.data.labels.push(label);
            chart.data.datasets.forEach((dataset) => {
                dataset.data.push(data);
            });

            if (chart.data.labels.length > MAX_DATA_POINTS) {
                chart.data.labels.shift();
                chart.data.datasets.forEach((dataset) => {
                    dataset.data.shift();
                });
            }
            chart.update();
        }

        // --- Main Logic ---

        async function updateDashboard() {
            try {
                let response;
                let errorLog = [];

                // 1. Direct
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 3000); 
                    response = await fetch(API_URL, { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`Direct Error: ${response.status}`);
                } catch (e) {
                    errorLog.push("Direct: " + e.message);
                    response = null;
                }

                // 2. Proxy (corsproxy.io)
                if (!response) {
                    try {
                        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(API_URL)}`;
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error(`Proxy1 Error: ${response.status}`);
                    } catch (e) {
                        errorLog.push("Proxy1: " + e.message);
                        response = null;
                    }
                }

                // 3. Proxy (allorigins)
                if (!response) {
                    try {
                        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(API_URL)}`;
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 5000);
                        response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        if (!response.ok) throw new Error(`Proxy2 Error: ${response.status}`);
                    } catch (e) {
                        errorLog.push("Proxy2: " + e.message);
                        response = null;
                    }
                }

                if (!response) {
                    throw new Error("Connection failed.");
                }
                
                const data = await response.json();
                
                setOnline(true);
                renderMetrics(data);
                updateCharts(data); 
                
            } catch (error) {
                console.error("Dashboard Update Error:", error);
                setOnline(false);
            }
        }

        function setOnline(isOnline) {
            const statusBadge = document.getElementById('main-status');
            
            if (isOnline) {
                statusBadge.className = "px-4 py-1.5 rounded-full bg-green-500/10 border border-green-500 text-green-400 text-sm font-bold inline-flex items-center gap-2 transition-all shadow-[0_0_15px_rgba(34,197,94,0.3)]";
                statusBadge.innerHTML = `<i class="fa-solid fa-circle-check text-green-500 text-lg"></i> ONLINE`;
            } else {
                statusBadge.className = "px-4 py-1.5 rounded-full bg-red-500/10 border border-red-500 text-red-400 text-sm font-bold inline-flex items-center gap-2 transition-all shadow-[0_0_15px_rgba(239,68,68,0.3)]";
                statusBadge.innerHTML = `<i class="fa-solid fa-circle-xmark text-red-500 text-lg"></i> OFFLINE`;
            }
        }

        function renderMetrics(data) {
            const container = document.getElementById('metrics-container');
            container.innerHTML = ''; 

            Object.keys(data).forEach(key => {
                const value = data[key];
                const keyLower = key.toLowerCase();
                
                let displayValue = value;
                let subtext = "";
                
                // --- SPECIAL HANDLING FOR UPTIME OBJECT ---
                if (keyLower === 'uptime' && typeof value === 'object' && value !== null) {
                    if (value.formatted) {
                        displayValue = value.formatted;
                    } else {
                        // Fallback construction if formatted is missing
                        displayValue = `${value.days || 0}d ${value.hours || 0}h ${value.minutes || 0}m`;
                    }
                    subtext = "Duration";
                }
                // Skip other complex objects
                else if (typeof value === 'object' && value !== null) {
                    return;
                }
                // Handle standard scalar values
                else {
                    if (keyLower.includes('uptime') || keyLower.includes('standing') || keyLower.includes('duration')) {
                        subtext = "Days : Hours : Mins";
                        if (!isNaN(value)) displayValue = formatUptime(value);
                    }
                    
                    if ((keyLower.includes('cpu') || keyLower.includes('load')) && !String(value).includes('%')) {
                        displayValue += "%";
                    }
                }

                let iconClass = 'fa-chart-simple'; 
                Object.keys(ICONS).forEach(term => {
                    if (keyLower.includes(term)) iconClass = ICONS[term];
                });

                const card = document.createElement('div');
                card.className = "metric-card p-5 relative overflow-hidden group";
                
                card.innerHTML = `
                    <div class="flex justify-between items-start mb-3">
                        <span class="text-slate-400 text-xs font-bold uppercase tracking-wider">${key.replace(/_/g, ' ')}</span>
                        <i class="fa-solid ${iconClass} text-indigo-400 opacity-60"></i>
                    </div>
                    <div class="text-3xl font-bold text-white tracking-tight truncate" title="${typeof displayValue === 'string' ? displayValue : value}">
                        ${displayValue}
                    </div>
                    ${subtext ? `<div class="text-xs text-slate-500 mt-2 font-mono">${subtext}</div>` : ''}
                `;
                
                container.appendChild(card);
            });
        }

        initCharts();
        updateDashboard();
        setInterval(updateDashboard, REFRESH_RATE);

    </script>
</body>
</html>
